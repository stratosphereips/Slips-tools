# Slips Evidence Log DAG Generator

This directory contains tools for generating textual DAGs (Directed Acyclic Graphs) from Slips network security evidence logs, supporting both IP-based chronological analysis and per-analysis alert investigation.

## Directory Structure

```
slips-tools/finetune/rawdata/
├── README_slips_dag.md                 # Main documentation
├── slips_dag_generator.py              # Main tool script
├── sample_logs/                        # Sample log files for testing
│   ├── slips-1.log
│   ├── slips-5.log
│   ├── slips-evidence.log
│   ├── slips-normal.log
│   ├── slips-normal-2.log
│   ├── slips-normal-3.log
│   ├── slips.log
│   └── test_data.log
├── examples/                           # Example outputs and demos
│   ├── sample_dag_output.txt
│   └── output.txt
└── tests/                              # Future test files
```

## Files

- **`slips_dag_generator.py`** - Python script that automatically parses Slips logs and generates textual DAGs (supports both IP-based and per-analysis modes)
- **`analyze_slips_with_llm.sh`** - Shell script wrapper integrating DAG generation with LLM analysis
- **`sample_logs/`** - Directory containing sample Slips evidence log files for testing
- **`examples/`** - Directory containing example outputs generated by the DAG generator

## Python Script Usage

### Basic Usage

#### IP-based Analysis (Default Mode)
```bash
# Generate compact DAG for single IP (default format)
python3 slips_dag_generator.py sample_logs/test_data.log 192.168.1.113

# Process ALL IP addresses in log file automatically
python3 slips_dag_generator.py sample_logs/test_data.log --all-ips

# All IPs with minimal summary format
python3 slips_dag_generator.py sample_logs/test_data.log --all-ips --minimal

# Include threat level information
python3 slips_dag_generator.py sample_logs/test_data.log --all-ips --include-threat-level

# Export all IPs as structured JSON
python3 slips_dag_generator.py sample_logs/test_data.log --all-ips --json
```

#### Per-Analysis Mode (DAG per Alert)
```bash
# Generate separate DAG for each alert/analysis
python3 slips_dag_generator.py sample_logs/slips.log --per-analysis --compact

# Per-analysis for specific IP with threat levels
python3 slips_dag_generator.py sample_logs/slips.log 192.168.1.113 --per-analysis --minimal --include-threat-level

# All analyses with pattern breakdown
python3 slips_dag_generator.py sample_logs/slips.log --per-analysis --pattern
```

### Command Line Options

**Required Arguments:**
- `log_file` - Path to the Slips evidence log file
- `target_ip` - IP address to analyze (optional when using `--all-ips` or `--per-analysis`)

**Analysis Mode Options:**
- `--all-ips`, `-a` - Process ALL IP addresses in log file (IP-based mode)
- `--per-analysis` - Generate separate DAG for each alert/analysis instead of per IP

**Output Format Options (mutually exclusive):**
- `--compact`, `-c` - Compact single-line format (default)
- `--minimal`, `-m` - Minimal bullet-point summary  
- `--pattern`, `-p` - Attack pattern analysis format
- `--full`, `-f` - Full verbose format (original)

**Filtering Options:**
- `--min-threat LEVEL` - Filter by minimum threat level (info, low, medium, high, critical) - IP-based mode only
- `--max-events N` - Limit to N most significant events - IP-based mode only
- `--group-time MINUTES` - Group events within N-minute windows

**Output Options:**
- `--output`, `-o` - Output file path (default: stdout)
- `--summary`, `-s` - Include summary statistics (not with minimal format)
- `--json`, `-j` - Output raw events as JSON instead of DAG (IP-based mode only)
- `--include-threat-level` - Include threat level information and risk analysis in output
- `--verbose`, `-v` - Enable verbose logging
- `--help`, `-h` - Show help message

### Example Output Formats

#### IP-based Mode Output

**Compact Format (default):**
```
192.168.1.113
├─ 23:27:45 → Scan: 443. (1t, 5p) [0.5]
├─ 23:27:49 → C&C: 88.11.164.60 (s:0.9910.) [0.03]
├─ 23:27:54 → Blacklist: 92.12.70.54 (OPALTELECOM-AS) [1.0]
└─ 23:47:14 → No-DNS: 195.113.232.73 [0.8]
```

**Minimal Format with Risk Analysis:**
```
192.168.1.113 Attack Summary:
• 23:27 - Port scans: 443., 80. (max: 2 hosts) [HIGH]
• 23:27 - C&C channels: 1 connections [HIGH]
• 23:27 - DNS evasion: 1 connections [HIGH]
• Duration: 0.3 hours, 7 events
• Risk: CRITICAL - Multiple high-severity threats (4 events); diverse attack patterns (5 types)
```

#### Per-Analysis Mode Output

**Compact Format:**
```
192.168.1.113 - Analysis 1 (2023/11/03 23:27:49.132500)
Timewindow: 1970/01/01 00:00:19 to 1970/01/01 01:00:19
├─ 23:27:49 → Scan: 443/TCP (5t, 5p) [0.5]
├─ 23:27:49 → Private: 192.168.1.255:137 [0.6]
└─ 23:27:49 → Scan: 443/TCP (20t, 45p) [1.0]
```

**Minimal Format with Analysis Context:**
```
192.168.1.113 - Analysis 1 (2023/11/03 23:27:49.132500)
• 23:27 - Port scans: 443/TCP→30, 80/TCP→15 (max: 45 hosts) [HIGH]
• Evidence: 11 events in analysis
• Risk: CRITICAL - Multiple high-severity threats (8 events); high event volume (11 events)
```

## Analysis Modes

### IP-based Mode (Default)
- **Use case**: Traditional chronological analysis of all activity for specific IP addresses
- **Output**: Single DAG per IP showing all evidence events in chronological order
- **Best for**: Timeline reconstruction, comprehensive IP behavior analysis
- **Log format support**: Both standard and grouped alerts formats
- **Key features**: Multi-IP processing, JSON export, extensive filtering options

### Per-Analysis Mode (`--per-analysis`)
- **Use case**: Focus on individual Slips alert detections and their specific evidence
- **Output**: Separate DAG for each alert/analysis with associated evidence grouped by timewindow
- **Best for**: Alert investigation, incident response, evidence validation
- **Log format support**: Grouped alerts format only
- **Key benefits**:
  - Preserves alert context and evidence grouping
  - Individual risk assessment per analysis
  - Clear separation between different detection events
  - Easier correlation of evidence to specific alerts

## Features

### Supported Evidence Types

The script automatically classifies and extracts the following types of security evidence:

1. **Port Scans** - Horizontal and vertical port scanning activities
2. **C&C Channels** - Command and control server connections
3. **Blacklisted IPs** - Connections to known malicious IP addresses
4. **Suspicious Connections** - Non-HTTP/SSL connections to unexpected ports
5. **Private IP Connections** - Connections to private/internal IP addresses
6. **DNS Issues** - Connections without proper DNS resolution
7. **Unencrypted Traffic** - HTTP traffic that should be encrypted
8. **Malicious Detections** - IPs detected as malicious by Slips

### Output Formats

1. **Textual DAG** - Hierarchical tree structure showing chronological events
2. **JSON Export** - Structured data export for further processing
3. **Summary Statistics** - Event type counts and threat level distribution

### Key Benefits

- **Dual Analysis Modes** - Both IP-centric timeline analysis and alert-focused investigation
- **Threat Context** - Optional threat levels, confidence scores, and comprehensive risk analysis
- **Rich Details** - AS information, port numbers, packet counts where available
- **Incident Response Ready** - Formatted for security analyst workflows
- **Automated Processing** - No manual log parsing required
- **Alert Preservation** - Per-analysis mode maintains Slips detection context

## Example Use Cases

### IP-based Mode Use Cases

#### 1. Incident Response - Complete Network View
```bash
python3 slips_dag_generator.py sample_logs/slips-evidence.log --all-ips --minimal --include-threat-level
```

#### 2. Threat Hunting - Single IP Analysis
```bash
python3 slips_dag_generator.py sample_logs/slips-normal.log 10.0.2.15 --full --summary
```

#### 3. Report Generation - Multi-IP JSON Export
```bash
python3 slips_dag_generator.py sample_logs/slips-5.log --all-ips --json --output network_threats.json
```

### Per-Analysis Mode Use Cases

#### 4. Alert Investigation - Individual Detection Analysis
```bash
python3 slips_dag_generator.py sample_logs/slips.log --per-analysis --minimal --include-threat-level
```

#### 5. Incident Timeline - Alert-by-Alert Breakdown
```bash
python3 slips_dag_generator.py sample_logs/slips.log --per-analysis --pattern
```

#### 6. Evidence Validation - Verify Alert Accuracy
```bash
python3 slips_dag_generator.py sample_logs/slips.log 192.168.1.113 --per-analysis --compact --summary
```

### Shell Script Integration

#### 7. LLM-Enhanced Analysis
```bash
# IP-based analysis with AI insights
./analyze_slips_with_llm.sh sample_logs/slips.log 192.168.1.113 --detailed

# Per-analysis mode with LLM
./analyze_slips_with_llm.sh sample_logs/slips.log --per-analysis --format minimal
```

## Technical Details

### Log Format Requirements

#### Standard Format (IP-based mode only)
- Timestamp in `YYYY/MM/DD HH:MM:SS.microseconds` format
- `[Evidence]` markers for evidence lines
- Profile identifiers as `profile_X.X.X.X`
- Threat level and confidence information where available

#### Grouped Alerts Format (supports both modes)
- Alert headers with `detected as malicious in timewindow X`
- Evidence lists under `given the following evidence:`
- Timewindow information with start/stop timestamps
- **Required for per-analysis mode**

### Event Classification

Events are classified using regex patterns that match specific Slips evidence formats. The script handles various log formats and extracts relevant security context automatically.

### Performance

- Processes large log files efficiently
- Memory usage scales with events per IP (IP-based) or events per alert (analysis-based)
- Suitable for real-time analysis of ongoing incidents
- Per-analysis mode optimized for alert-focused workflows

## Dependencies

- Python 3.6+
- Standard library only (no external dependencies required)

## Integration

The script can be easily integrated into:
- Security orchestration platforms (SOAR)
- Incident response workflows
- Automated threat hunting pipelines
- Security information and event management (SIEM) systems